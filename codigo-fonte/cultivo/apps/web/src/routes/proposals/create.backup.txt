import { createFileRoute, useNavigate } from "@tanstack/react-router";import { createFileRoute, useNavigate } from "@tanstack/react-router";import { createFileRoute, useNavigate } from "@tanstack/react-router";

import { ArrowLeft, Package, User, Users, TrendingUp } from "lucide-react";

import { useState, useEffect } from "react";import { ArrowLeft, Package, User, Users, TrendingUp } from "lucide-react";import { ArrowLeft, Package, User, Users, TrendingUp } from "lucide-react";

import { useMutation } from "convex/react";

import { api } from "../../../../../packages/backend/convex/_generated/api.js";import { useState, useEffect } from "react";import { useState, useEffect } from "react";

import { Button } from "@/components/ui/button";

import { Card, CardContent } from "@/components/ui/card";import { useMutation } from "convex/react";import { useMutation } from "convex/react";

import { Input } from "@/components/ui/input";

import { Label } from "@/components/ui/label";import { api } from "../../../../../packages/backend/convex/_generated/api.js";import { api } from "../../../../../packages/backend/convex/_generated/api.js";

import { toast } from "sonner";

import { Button } from "@/components/ui/button";import { Button } from "@/components/ui/button";

export const Route = createFileRoute("/proposals/create")({

  component: CreateProposalPage,import { Card, CardContent } from "@/components/ui/card";import { Card, CardContent } from "@/components/ui/card";

});

import { Input } from "@/components/ui/input";import { Input } from "@/components/ui/input";

interface Harvest {

  _id: string;import { Label } from "@/components/ui/label";import { Label } from "@/components/ui/label";

  quantity: number;

  dateOfHarvest: string;import { toast } from "sonner";import { toast } from "sonner";

  producer: {

    _id: string;

    name: string;

    email: string;export const Route = createFileRoute("/proposals/create")({export const Route = createFileRoute("/proposals/create")({

  } | null;

  group: {  component: CreateProposalPage,  component: CreateProposalPage,

    _id: string;

    name: string;});});

    createdBy: string;

  } | null;

}

interface Harvest {interface Harvest {

// Dados mocados temporários até a funcionalidade de colheitas ser implementada

const mockHarvests: Harvest[] = [  _id: string;  _id: string;

  {

    _id: "harvest1",  quantity: number;  quantity: number;

    quantity: 150,

    dateOfHarvest: "2025-10-15",  dateOfHarvest: string;  dateOfHarvest: string;

    producer: {

      _id: "prod1",  producer: {  producer: {

      name: "João Silva",

      email: "joao@example.com",    _id: string;    _id: string;

    },

    group: null,    name: string;    name: string;

  },

  {    email: string;    email: string;

    _id: "harvest2",

    quantity: 200,  } | null;  } | null;

    dateOfHarvest: "2025-10-20",

    producer: null,  group: {  group: {

    group: {

      _id: "group1",    _id: string;    _id: string;

      name: "Cooperativa do Vale",

      createdBy: "user123",    name: string;    name: string;

    },

  },    createdBy: string;    createdBy: string;

  {

    _id: "harvest3",  } | null;  } | null;

    quantity: 80,

    dateOfHarvest: "2025-11-01",}}

    producer: {

      _id: "prod2",

      name: "Maria Santos",

      email: "maria@example.com",// Dados mocados temporários até a funcionalidade de colheitas ser implementada// Dados mocados temporários até a funcionalidade de colheitas ser implementada

    },

    group: null,const mockHarvests: Harvest[] = [const mockHarvests: Harvest[] = [

  },

  {  {  {

    _id: "harvest4",

    quantity: 300,    _id: "harvest1",    _id: "harvest1",

    dateOfHarvest: "2025-10-25",

    producer: null,    quantity: 150,    quantity: 150,

    group: {

      _id: "group2",    dateOfHarvest: "2025-10-15",    dateOfHarvest: "2025-10-15",

      name: "Grupo Sertão",

      createdBy: "user456",    producer: {    producer: {

    },

  },      _id: "prod1",      _id: "prod1",

];

      name: "João Silva",      name: "João Silva",

function CreateProposalPage() {

  const navigate = useNavigate();      email: "joao@example.com",      email: "joao@example.com",

  const [selectedHarvest, setSelectedHarvest] = useState<Harvest | null>(null);

  const [quantity, setQuantity] = useState<string>("");    },    },

  const [valuePerSack, setValuePerSack] = useState<string>("");

  const [currentUserId, setCurrentUserId] = useState<string>("");    group: null,    group: null,



  // Usar dados mocados temporariamente  },  },

  const harvests = mockHarvests;

  {  {

  // Mutation para criar proposta

  const createProposal = useMutation(api.proposals.createProposal);    _id: "harvest2",    _id: "harvest2",



  useEffect(() => {    quantity: 200,    quantity: 200,

    const userData = localStorage.getItem("user");

    if (userData) {    dateOfHarvest: "2025-10-20",    dateOfHarvest: "2025-10-20",

      const user = JSON.parse(userData);

      setCurrentUserId(user._id || "");    producer: null,    producer: null,

    }

  }, []);    group: {    group: {



  const handleSelectHarvest = (harvest: Harvest) => {      _id: "group1",      _id: "group1",

    setSelectedHarvest(harvest);

    setQuantity("");      name: "Cooperativa do Vale",      name: "Cooperativa do Vale",

    setValuePerSack("");

  };      createdBy: "user123",      createdBy: "user123",



  const handleSubmit = async (e: React.FormEvent) => {    },    },

    e.preventDefault();

  },  },

    if (!selectedHarvest) {

      toast.error("Selecione uma colheita");  {  {

      return;

    }    _id: "harvest3",    _id: "harvest3",



    const quantityNum = Number.parseInt(quantity);    quantity: 80,    quantity: 80,

    const valueNum = Number.parseFloat(valuePerSack);

    dateOfHarvest: "2025-11-01",    dateOfHarvest: "2025-11-01",

    if (!quantityNum || quantityNum <= 0) {

      toast.error("Informe uma quantidade válida");    producer: {    producer: {

      return;

    }      _id: "prod2",      _id: "prod2",



    if (quantityNum > selectedHarvest.quantity) {      name: "Maria Santos",      name: "Maria Santos",

      toast.error(

        `A quantidade não pode ser maior que ${selectedHarvest.quantity} sacas disponíveis`      email: "maria@example.com",      email: "maria@example.com",

      );

      return;    },    },

    }

    group: null,    group: null,

    if (!valueNum || valueNum <= 0) {

      toast.error("Informe um valor por saca válido");  },  },

      return;

    }  {  {



    if (!currentUserId) {    _id: "harvest4",    _id: "harvest4",

      toast.error("Usuário não identificado");

      return;    quantity: 300,    quantity: 300,

    }

    dateOfHarvest: "2025-10-25",    dateOfHarvest: "2025-10-25",

    try {

      const userData = localStorage.getItem("user");    producer: null,    producer: null,

      const user = userData ? JSON.parse(userData) : null;

    group: {    group: {

      await createProposal({

        groupId: selectedHarvest.group?._id as any,      _id: "group2",      _id: "group2",

        userId: selectedHarvest.group ? undefined : (selectedHarvest.producer?._id as any),

        valuePerSack: valueNum,      name: "Grupo Sertão",      name: "Grupo Sertão",

        quantity: quantityNum,

        phoneBuyer: user?.telefone || "",      createdBy: "user456",      createdBy: "user456",

        emailBuyer: user?.email || "",

        nameBuyer: user?.name || "Representante",    },    },

        buyerId: currentUserId as any,

      });  },  },



      toast.success("Proposta enviada com sucesso!");];];

      navigate({ to: "/proposals" });

    } catch (error) {

      toast.error("Erro ao enviar proposta");

      console.error(error);function CreateProposalPage() {function CreateProposalPage() {

    }

  };  const navigate = useNavigate();  const navigate = useNavigate();



  return (  const [selectedHarvest, setSelectedHarvest] = useState<Harvest | null>(null);  const [selectedHarvest, setSelectedHarvest] = useState<Harvest | null>(null);

    <div className="min-h-screen bg-[#F5F1E8] mt-16">

      {/* Header */}  const [quantity, setQuantity] = useState<string>("");  const [quantity, setQuantity] = useState<string>("");

      <div className="flex items-center h-14 px-4 bg-white border-b">

        <button  const [valuePerSack, setValuePerSack] = useState<string>("");  const [valuePerSack, setValuePerSack] = useState<string>("");

          onClick={() => navigate({ to: "/proposals" })}

          className="p-1.5 text-[#62331B] cursor-pointer"  const [currentUserId, setCurrentUserId] = useState<string>("");  const [currentUserId, setCurrentUserId] = useState<string>("");

        >

          <ArrowLeft className="w-6 h-6" />

        </button>

        <span className="flex-1 text-center font-semibold text-[#62331B]">  // Usar dados mocados temporariamente  // Usar dados mocados temporariamente

          Nova Proposta

        </span>  const harvests = mockHarvests;  const harvests = mockHarvests;

      </div>



      {/* Content */}

      <div className="p-4 space-y-4">  // Mutation para criar proposta  // Mutation para criar proposta

        {selectedHarvest ? (

          <form onSubmit={handleSubmit} className="space-y-4">  const createProposal = useMutation(api.proposals.createProposal);  const createProposal = useMutation(api.proposals.createProposal);

            {/* Colheita Selecionada */}

            <Card className="bg-white shadow-sm border-l-4 border-l-green-500">

              <CardContent className="p-4">

                <div className="flex items-start justify-between mb-2">  useEffect(() => {  useEffect(() => {

                  <div>

                    <h3 className="text-lg font-semibold text-green-700 flex items-center gap-2">    const userData = localStorage.getItem("user");    const userData = localStorage.getItem("user");

                      {selectedHarvest.group ? (

                        <>    if (userData) {    if (userData) {

                          <Users className="w-5 h-5" />

                          {selectedHarvest.group.name}      const user = JSON.parse(userData);      const user = JSON.parse(userData);

                        </>

                      ) : (      setCurrentUserId(user._id || "");      setCurrentUserId(user._id || "");

                        <>

                          <User className="w-5 h-5" />    }    }

                          {selectedHarvest.producer?.name || "Produtor"}

                        </>  }, []);  }, []);

                      )}

                    </h3>

                  </div>

                  <Button  const handleSelectHarvest = (harvest: Harvest) => {  const handleSelectHarvest = (harvest: Harvest) => {

                    type="button"

                    variant="outline"    setSelectedHarvest(harvest);    setSelectedHarvest(harvest);

                    size="sm"

                    onClick={() => setSelectedHarvest(null)}    setQuantity("");    setQuantity("");

                  >

                    Trocar    setValuePerSack("");    setValuePerSack("");

                  </Button>

                </div>  };  };



                <div className="space-y-1 text-sm">

                  <p>

                    <span className="font-medium">Disponível:</span>{" "}  const handleSubmit = async (e: React.FormEvent) => {  const handleSubmit = async (e: React.FormEvent) => {

                    {selectedHarvest.quantity} sacas

                  </p>    e.preventDefault();    e.preventDefault();

                  <p>

                    <span className="font-medium">Data:</span>{" "}

                    {new Date(selectedHarvest.dateOfHarvest).toLocaleDateString("pt-BR")}

                  </p>    if (!selectedHarvest) {    if (!selectedHarvest) {

                </div>

              </CardContent>      toast.error("Selecione uma colheita");      toast.error("Selecione uma colheita");

            </Card>

      return;      return;

            {/* Formulário */}

            <Card className="bg-white shadow-sm">    }    }

              <CardContent className="p-4 space-y-4">

                <div>

                  <Label htmlFor="quantity" className="text-[#62331B] font-semibold">

                    Quantidade de Sacas    const quantityNum = Number.parseInt(quantity);    const quantityNum = Number.parseInt(quantity);

                  </Label>

                  <Input    const valueNum = Number.parseFloat(valuePerSack);    const valueNum = Number.parseFloat(valuePerSack);

                    id="quantity"

                    type="number"

                    placeholder="Ex: 50"

                    value={quantity}    if (!quantityNum || quantityNum <= 0) {    if (!quantityNum || quantityNum <= 0) {

                    onChange={(e) => setQuantity(e.target.value)}

                    min="1"      toast.error("Informe uma quantidade válida");      toast.error("Informe uma quantidade válida");

                    max={selectedHarvest.quantity}

                    className="mt-1.5"      return;      return;

                    required

                  />    }    }

                  <p className="text-xs text-gray-500 mt-1">

                    Máximo: {selectedHarvest.quantity} sacas

                  </p>

                </div>    if (quantityNum > selectedHarvest.quantity) {    if (quantityNum > selectedHarvest.quantity) {



                <div>      toast.error(      toast.error(

                  <Label htmlFor="valuePerSack" className="text-[#62331B] font-semibold">

                    Valor por Saca (R$)        `A quantidade não pode ser maior que ${selectedHarvest.quantity} sacas disponíveis`        `A quantidade não pode ser maior que ${selectedHarvest.quantity} sacas disponíveis`

                  </Label>

                  <Input      );      );

                    id="valuePerSack"

                    type="number"      return;      return;

                    step="0.01"

                    placeholder="Ex: 385.50"    }    }

                    value={valuePerSack}

                    onChange={(e) => setValuePerSack(e.target.value)}

                    min="0.01"

                    className="mt-1.5"    if (!valueNum || valueNum <= 0) {    if (!valueNum || valueNum <= 0) {

                    required

                  />      toast.error("Informe um valor por saca válido");      toast.error("Informe um valor por saca válido");

                </div>

      return;      return;

                {quantity && valuePerSack && (

                  <div className="bg-green-50 border border-green-200 rounded-lg p-3">    }    }

                    <p className="text-sm text-gray-700 mb-1">

                      <span className="font-medium">Valor Total da Proposta:</span>

                    </p>

                    <p className="text-2xl font-bold text-green-700">    if (!currentUserId) {    if (!currentUserId) {

                      R${" "}

                      {(Number.parseFloat(valuePerSack) * Number.parseInt(quantity)).toFixed(2)}      toast.error("Usuário não identificado");      toast.error("Usuário não identificado");

                    </p>

                  </div>      return;      return;

                )}

              </CardContent>    }    }

            </Card>



            {/* Botões */}

            <div className="space-y-2">    try {    try {

              <Button

                type="submit"      const userData = localStorage.getItem("user");      const userData = localStorage.getItem("user");

                className="w-full bg-[#62331B] text-white hover:bg-[#4a2415] cursor-pointer"

                size="lg"      const user = userData ? JSON.parse(userData) : null;      const user = userData ? JSON.parse(userData) : null;

              >

                Enviar Proposta

              </Button>

      await createProposal({      await createProposal({

              <Button

                type="button"        groupId: selectedHarvest.group?._id as any,        groupId: selectedHarvest.group?._id as any,

                variant="outline"

                className="w-full cursor-pointer"        userId: selectedHarvest.group ? undefined : (selectedHarvest.producer?._id as any),        userId: selectedHarvest.group ? undefined : (selectedHarvest.producer?._id as any),

                onClick={() => navigate({ to: "/proposals" })}

              >        valuePerSack: valueNum,        valuePerSack: valueNum,

                Cancelar

              </Button>        quantity: quantityNum,        quantity: quantityNum,

            </div>

          </form>        phoneBuyer: user?.telefone || "",        phoneBuyer: user?.telefone || "",

        ) : (

          <>        emailBuyer: user?.email || "",        emailBuyer: user?.email || "",

            <div className="bg-white rounded-lg p-4 shadow-sm">

              <h2 className="text-lg font-semibold text-[#62331B] mb-2">        nameBuyer: user?.name || "Representante",        nameBuyer: user?.name || "Representante",

                Selecione uma Colheita

              </h2>        buyerId: currentUserId as any,        buyerId: currentUserId as any,

              <p className="text-sm text-gray-600 mb-4">

                Escolha a colheita para fazer sua proposta de compra      });      });

              </p>

            </div>



            {harvests.length === 0 ? (      toast.success("Proposta enviada com sucesso!");      toast.success("Proposta enviada com sucesso!");

              <div className="text-center py-12 bg-white rounded-lg">

                <Package className="w-12 h-12 mx-auto text-gray-400 mb-3" />      navigate({ to: "/proposals" });      navigate({ to: "/proposals" });

                <p className="text-gray-500">

                  Nenhuma colheita disponível no momento    } catch (error) {    } catch (error) {

                </p>

              </div>      toast.error("Erro ao enviar proposta");      toast.error("Erro ao enviar proposta");

            ) : (

              <div className="space-y-3">      console.error(error);      console.error(error);

                {harvests.map((harvest) => (

                  <Card    }    }

                    key={harvest._id}

                    className="bg-white shadow-sm hover:shadow-md transition-shadow cursor-pointer border-l-4 border-l-green-500"  };  };

                    onClick={() => handleSelectHarvest(harvest)}

                  >

                    <CardContent className="p-4">

                      <div className="flex items-start justify-between mb-3">  return (  return (

                        <div>

                          <h3 className="text-lg font-semibold text-green-700 flex items-center gap-2">    <div className="min-h-screen bg-[#F5F1E8] mt-16">    <div className="min-h-screen bg-[#F5F1E8] mt-16">

                            {harvest.group ? (

                              <>      {/* Header */}      {/* Header */}

                                <Users className="w-5 h-5" />

                                {harvest.group.name}      <div className="flex items-center h-14 px-4 bg-white border-b">      <div className="flex items-center h-14 px-4 bg-white border-b">

                              </>

                            ) : (        <button        <button

                              <>

                                <User className="w-5 h-5" />          onClick={() => navigate({ to: "/proposals" })}          onClick={() => navigate({ to: "/proposals" })}

                                {harvest.producer?.name || "Produtor"}

                              </>          className="p-1.5 text-[#62331B] cursor-pointer"          className="p-1.5 text-[#62331B] cursor-pointer"

                            )}

                          </h3>        >        >

                          <p className="text-sm text-gray-600 mt-1">

                            {harvest.group ? "Colheita do Grupo" : "Colheita Individual"}          <ArrowLeft className="w-6 h-6" />          <ArrowLeft className="w-6 h-6" />

                          </p>

                        </div>        </button>        </button>

                      </div>

        <span className="flex-1 text-center font-semibold text-[#62331B]">        <span className="flex-1 text-center font-semibold text-[#62331B]">

                      <div className="space-y-2">

                        <div className="flex items-center gap-2">          Nova Proposta          Nova Proposta

                          <Package className="w-4 h-4 text-gray-500" />

                          <span className="text-sm">        </span>        </span>

                            <span className="font-medium">Quantidade:</span>{" "}

                            {harvest.quantity} sacas disponíveis      </div>      </div>

                          </span>

                        </div>

                        <div className="flex items-center gap-2">

                          <TrendingUp className="w-4 h-4 text-gray-500" />      {/* Content */}      {/* Content */}

                          <span className="text-sm">

                            <span className="font-medium">Data da Colheita:</span>{" "}      <div className="p-4 space-y-4">      <div className="p-4 space-y-4">

                            {new Date(harvest.dateOfHarvest).toLocaleDateString("pt-BR")}

                          </span>        {selectedHarvest ? (        {selectedHarvest ? (

                        </div>

                      </div>          <form onSubmit={handleSubmit} className="space-y-4">          <form onSubmit={handleSubmit} className="space-y-4">



                      <div className="mt-3 pt-3 border-t">            {/* Colheita Selecionada */}            {/* Colheita Selecionada */}

                        <Button

                          size="sm"            <Card className="bg-white shadow-sm border-l-4 border-l-green-500">            <Card className="bg-white shadow-sm border-l-4 border-l-green-500">

                          className="w-full bg-[#62331B] text-white hover:bg-[#4a2415]"

                        >              <CardContent className="p-4">              <CardContent className="p-4">

                          Fazer Proposta

                        </Button>                <div className="flex items-start justify-between mb-2">                <div className="flex items-start justify-between mb-2">

                      </div>

                    </CardContent>                  <div>                  <div>

                  </Card>

                ))}                    <h3 className="text-lg font-semibold text-green-700 flex items-center gap-2">                    <h3 className="text-lg font-semibold text-green-700 flex items-center gap-2">

              </div>

            )}                      {selectedHarvest.group ? (                      {selectedHarvest.group ? (

          </>

        )}                        <>                        <>

      </div>

    </div>                          <Users className="w-5 h-5" />                          <Users className="w-5 h-5" />

  );

}                          {selectedHarvest.group.name}                          {selectedHarvest.group.name}


                        </>                        </>

                      ) : (                      ) : (

                        <>                        <>

                          <User className="w-5 h-5" />                          <User className="w-5 h-5" />

                          {selectedHarvest.producer?.name || "Produtor"}                          {selectedHarvest.producer?.name || "Produtor"}

                        </>                        </>

                      )}                      )}

                    </h3>                    </h3>

                  </div>                  </div>

                  <Button                  <Button

                    type="button"                    type="button"

                    variant="outline"                    variant="outline"

                    size="sm"                    size="sm"

                    onClick={() => setSelectedHarvest(null)}                    onClick={() => setSelectedHarvest(null)}

                  >                  >

                    Trocar                    Trocar

                  </Button>                  </Button>

                </div>                </div>



                <div className="space-y-1 text-sm">                <div className="space-y-1 text-sm">

                  <p>                  <p>

                    <span className="font-medium">Disponível:</span>{" "}                    <span className="font-medium">Disponível:</span>{" "}

                    {selectedHarvest.quantity} sacas                    {selectedHarvest.quantity} sacas

                  </p>                  </p>

                  <p>                  <p>

                    <span className="font-medium">Data:</span>{" "}                    <span className="font-medium">Data:</span>{" "}

                    {new Date(selectedHarvest.dateOfHarvest).toLocaleDateString("pt-BR")}                    {new Date(selectedHarvest.dateOfHarvest).toLocaleDateString("pt-BR")}

                  </p>                  </p>

                </div>                </div>

              </CardContent>              </CardContent>

            </Card>            </Card>



            {/* Formulário */}            {/* Formulário */}

            <Card className="bg-white shadow-sm">            <Card className="bg-white shadow-sm">

              <CardContent className="p-4 space-y-4">              <CardContent className="p-4 space-y-4">

                <div>                <div>

                  <Label htmlFor="quantity" className="text-[#62331B] font-semibold">                  <Label htmlFor="quantity" className="text-[#62331B] font-semibold">

                    Quantidade de Sacas                    Quantidade de Sacas

                  </Label>                  </Label>

                  <Input                  <Input

                    id="quantity"                    id="quantity"

                    type="number"                    type="number"

                    placeholder="Ex: 50"                    placeholder="Ex: 50"

                    value={quantity}                    value={quantity}

                    onChange={(e) => setQuantity(e.target.value)}                    onChange={(e) => setQuantity(e.target.value)}

                    min="1"                    min="1"

                    max={selectedHarvest.quantity}                    max={selectedHarvest.quantity}

                    className="mt-1.5"                    className="mt-1.5"

                    required                    required

                  />                  />

                  <p className="text-xs text-gray-500 mt-1">                  <p className="text-xs text-gray-500 mt-1">

                    Máximo: {selectedHarvest.quantity} sacas                    Máximo: {selectedHarvest.quantity} sacas

                  </p>                  </p>

                </div>                </div>



                <div>                <div>

                  <Label htmlFor="valuePerSack" className="text-[#62331B] font-semibold">                  <Label htmlFor="valuePerSack" className="text-[#62331B] font-semibold">

                    Valor por Saca (R$)                    Valor por Saca (R$)

                  </Label>                  </Label>

                  <Input                  <Input

                    id="valuePerSack"                    id="valuePerSack"

                    type="number"                    type="number"

                    step="0.01"                    step="0.01"

                    placeholder="Ex: 385.50"                    placeholder="Ex: 385.50"

                    value={valuePerSack}                    value={valuePerSack}

                    onChange={(e) => setValuePerSack(e.target.value)}                    onChange={(e) => setValuePerSack(e.target.value)}

                    min="0.01"                    min="0.01"

                    className="mt-1.5"                    className="mt-1.5"

                    required                    required

                  />                  />

                </div>                </div>



                {quantity && valuePerSack && (                {quantity && valuePerSack && (

                  <div className="bg-green-50 border border-green-200 rounded-lg p-3">                  <div className="bg-green-50 border border-green-200 rounded-lg p-3">

                    <p className="text-sm text-gray-700 mb-1">                    <p className="text-sm text-gray-700 mb-1">

                      <span className="font-medium">Valor Total da Proposta:</span>                      <span className="font-medium">Valor Total da Proposta:</span>

                    </p>                    </p>

                    <p className="text-2xl font-bold text-green-700">                    <p className="text-2xl font-bold text-green-700">

                      R${" "}                      R${" "}

                      {(Number.parseFloat(valuePerSack) * Number.parseInt(quantity)).toFixed(2)}                      {(Number.parseFloat(valuePerSack) * Number.parseInt(quantity)).toFixed(2)}

                    </p>                    </p>

                  </div>                  </div>

                )}                )}

              </CardContent>              </CardContent>

            </Card>            </Card>



            {/* Botões */}            {/* Botões */}

            <div className="space-y-2">            <div className="space-y-2">

              <Button              <Button

                type="submit"                type="submit"

                className="w-full bg-[#62331B] text-white hover:bg-[#4a2415] cursor-pointer"                className="w-full bg-[#62331B] text-white hover:bg-[#4a2415] cursor-pointer"

                size="lg"                size="lg"

              >              >

                Enviar Proposta                Enviar Proposta

              </Button>              </Button>



              <Button              <Button

                type="button"                type="button"

                variant="outline"                variant="outline"

                className="w-full cursor-pointer"                className="w-full cursor-pointer"

                onClick={() => navigate({ to: "/proposals" })}                onClick={() => navigate({ to: "/proposals" })}

              >              >

                Cancelar                Cancelar

              </Button>              </Button>

            </div>            </div>

          </form>          </form>

        ) : (        ) : (

          <>          <>

            <div className="bg-white rounded-lg p-4 shadow-sm">            <div className="bg-white rounded-lg p-4 shadow-sm">

              <h2 className="text-lg font-semibold text-[#62331B] mb-2">              <h2 className="text-lg font-semibold text-[#62331B] mb-2">

                Selecione uma Colheita                Selecione uma Colheita

              </h2>              </h2>

              <p className="text-sm text-gray-600 mb-4">              <p className="text-sm text-gray-600 mb-4">

                Escolha a colheita para fazer sua proposta de compra                Escolha a colheita para fazer sua proposta de compra

              </p>              </p>

            </div>            </div>



            {harvests.length === 0 ? (            {harvests.length === 0 ? (

              <div className="text-center py-12 bg-white rounded-lg">              <div className="text-center py-12 bg-white rounded-lg">

                <Package className="w-12 h-12 mx-auto text-gray-400 mb-3" />                <Package className="w-12 h-12 mx-auto text-gray-400 mb-3" />

                <p className="text-gray-500">                <p className="text-gray-500">

                  Nenhuma colheita disponível no momento                  Nenhuma colheita disponível no momento

                </p>                </p>

              </div>              </div>

            ) : (            ) : (

              <div className="space-y-3">              <div className="space-y-3">

                {harvests.map((harvest) => (                {harvests.map((harvest) => (

                  <Card                  <Card

                    key={harvest._id}                    key={harvest._id}

                    className="bg-white shadow-sm hover:shadow-md transition-shadow cursor-pointer border-l-4 border-l-green-500"                    className="bg-white shadow-sm hover:shadow-md transition-shadow cursor-pointer border-l-4 border-l-green-500"

                    onClick={() => handleSelectHarvest(harvest)}                    onClick={() => handleSelectHarvest(harvest)}

                  >                  >

                    <CardContent className="p-4">                    <CardContent className="p-4">

                      <div className="flex items-start justify-between mb-3">                      <div className="flex items-start justify-between mb-3">

                        <div>                        <div>

                          <h3 className="text-lg font-semibold text-green-700 flex items-center gap-2">                          <h3 className="text-lg font-semibold text-green-700 flex items-center gap-2">

                            {harvest.group ? (                            {harvest.group ? (

                              <>                              <>

                                <Users className="w-5 h-5" />                                <Users className="w-5 h-5" />

                                {harvest.group.name}                                {harvest.group.name}

                              </>                              </>

                            ) : (                            ) : (

                              <>                              <>

                                <User className="w-5 h-5" />                                <User className="w-5 h-5" />

                                {harvest.producer?.name || "Produtor"}                                {harvest.producer?.name || "Produtor"}

                              </>                              </>

                            )}                            )}

                          </h3>                          </h3>

                          <p className="text-sm text-gray-600 mt-1">                          <p className="text-sm text-gray-600 mt-1">

                            {harvest.group ? "Colheita do Grupo" : "Colheita Individual"}                            {harvest.group ? "Colheita do Grupo" : "Colheita Individual"}

                          </p>                          </p>

                        </div>                        </div>

                      </div>                      </div>



                      <div className="space-y-2">                      <div className="space-y-2">

                        <div className="flex items-center gap-2">                        <div className="flex items-center gap-2">

                          <Package className="w-4 h-4 text-gray-500" />                          <Package className="w-4 h-4 text-gray-500" />

                          <span className="text-sm">                          <span className="text-sm">

                            <span className="font-medium">Quantidade:</span>{" "}                            <span className="font-medium">Quantidade:</span>{" "}

                            {harvest.quantity} sacas disponíveis                            {harvest.quantity} sacas disponíveis

                          </span>                          </span>

                        </div>                        </div>

                        <div className="flex items-center gap-2">                        <div className="flex items-center gap-2">

                          <TrendingUp className="w-4 h-4 text-gray-500" />                          <TrendingUp className="w-4 h-4 text-gray-500" />

                          <span className="text-sm">                          <span className="text-sm">

                            <span className="font-medium">Data da Colheita:</span>{" "}                            <span className="font-medium">Data da Colheita:</span>{" "}

                            {new Date(harvest.dateOfHarvest).toLocaleDateString("pt-BR")}                            {new Date(harvest.dateOfHarvest).toLocaleDateString("pt-BR")}

                          </span>                          </span>

                        </div>                        </div>

                      </div>                      </div>



                      <div className="mt-3 pt-3 border-t">                      <div className="mt-3 pt-3 border-t">

                        <Button                        <Button

                          size="sm"                          size="sm"

                          className="w-full bg-[#62331B] text-white hover:bg-[#4a2415]"                          className="w-full bg-[#62331B] text-white hover:bg-[#4a2415]"

                        >                        >

                          Fazer Proposta                          Fazer Proposta

                        </Button>                        </Button>

                      </div>                      </div>

                    </CardContent>                    </CardContent>

                  </Card>                  </Card>

                ))}                ))}

              </div>              </div>

            )}            )}

          </>          </>

        )}        )}

      </div>      </div>

    </div>    </div>

  );  );

}}

                        <>
                          <Users className="w-5 h-5" />
                          {selectedHarvest.group.name}
                        </>
                      ) : (
                        <>
                          <User className="w-5 h-5" />
                          {selectedHarvest.producer?.name || "Produtor"}
                        </>
                      )}
                    </h3>
                  </div>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => setSelectedHarvest(null)}
                  >
                    Trocar
                  </Button>
                </div>

                <div className="space-y-1 text-sm">
                  <p>
                    <span className="font-medium">Disponível:</span>{" "}
                    {selectedHarvest.quantity} sacas
                  </p>
                  <p>
                    <span className="font-medium">Data:</span>{" "}
                    {new Date(selectedHarvest.dateOfHarvest).toLocaleDateString("pt-BR")}
                  </p>
                </div>
              </CardContent>
            </Card>

            {/* Formulário */}
            <Card className="bg-white shadow-sm">
              <CardContent className="p-4 space-y-4">
                <div>
                  <Label htmlFor="quantity" className="text-[#62331B] font-semibold">
                    Quantidade de Sacas
                  </Label>
                  <Input
                    id="quantity"
                    type="number"
                    placeholder="Ex: 50"
                    value={quantity}
                    onChange={(e) => setQuantity(e.target.value)}
                    min="1"
                    max={selectedHarvest.quantity}
                    className="mt-1.5"
                    required
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Máximo: {selectedHarvest.quantity} sacas
                  </p>
                </div>

                <div>
                  <Label htmlFor="valuePerSack" className="text-[#62331B] font-semibold">
                    Valor por Saca (R$)
                  </Label>
                  <Input
                    id="valuePerSack"
                    type="number"
                    step="0.01"
                    placeholder="Ex: 385.50"
                    value={valuePerSack}
                    onChange={(e) => setValuePerSack(e.target.value)}
                    min="0.01"
                    className="mt-1.5"
                    required
                  />
                </div>

                {quantity && valuePerSack && (
                  <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                    <p className="text-sm text-gray-700 mb-1">
                      <span className="font-medium">Valor Total da Proposta:</span>
                    </p>
                    <p className="text-2xl font-bold text-green-700">
                      R${" "}
                      {(Number.parseFloat(valuePerSack) * Number.parseInt(quantity)).toFixed(2)}
                    </p>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Botões */}
            <div className="space-y-2">
              <Button
                type="submit"
                className="w-full bg-[#62331B] text-white hover:bg-[#4a2415] cursor-pointer"
                size="lg"
              >
                Enviar Proposta
              </Button>

              <Button
                type="button"
                variant="outline"
                className="w-full cursor-pointer"
                onClick={() => navigate({ to: "/proposals" })}
              >
                Cancelar
              </Button>
            </div>
          </form>
        ) : (
          <>
            <div className="bg-white rounded-lg p-4 shadow-sm">
              <h2 className="text-lg font-semibold text-[#62331B] mb-2">
                Selecione uma Colheita
              </h2>
              <p className="text-sm text-gray-600 mb-4">
                Escolha a colheita para fazer sua proposta de compra
              </p>
            </div>

            {harvests.length === 0 ? (
              <div className="text-center py-12 bg-white rounded-lg">
                <Package className="w-12 h-12 mx-auto text-gray-400 mb-3" />
                <p className="text-gray-500">
                  Nenhuma colheita disponível no momento
                </p>
              </div>
            ) : (
              <div className="space-y-3">
                {harvests.map((harvest) => (
                  <Card
                    key={harvest._id}
                    className="bg-white shadow-sm hover:shadow-md transition-shadow cursor-pointer border-l-4 border-l-green-500"
                    onClick={() => handleSelectHarvest(harvest)}
                  >
                    <CardContent className="p-4">
                      <div className="flex items-start justify-between mb-3">
                        <div>
                          <h3 className="text-lg font-semibold text-green-700 flex items-center gap-2">
                            {harvest.group ? (
                              <>
                                <Users className="w-5 h-5" />
                                {harvest.group.name}
                              </>
                            ) : (
                              <>
                                <User className="w-5 h-5" />
                                {harvest.producer?.name || "Produtor"}
                              </>
                            )}
                          </h3>
                          <p className="text-sm text-gray-600 mt-1">
                            {harvest.group ? "Colheita do Grupo" : "Colheita Individual"}
                          </p>
                        </div>
                      </div>

                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          <Package className="w-4 h-4 text-gray-500" />
                          <span className="text-sm">
                            <span className="font-medium">Quantidade:</span>{" "}
                            {harvest.quantity} sacas disponíveis
                          </span>
                        </div>
                        <div className="flex items-center gap-2">
                          <TrendingUp className="w-4 h-4 text-gray-500" />
                          <span className="text-sm">
                            <span className="font-medium">Data da Colheita:</span>{" "}
                            {new Date(harvest.dateOfHarvest).toLocaleDateString("pt-BR")}
                          </span>
                        </div>
                      </div>

                      <div className="mt-3 pt-3 border-t">
                        <Button
                          size="sm"
                          className="w-full bg-[#62331B] text-white hover:bg-[#4a2415]"
                        >
                          Fazer Proposta
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            )}
          </>
        ) : (
          <form onSubmit={handleSubmit} className="space-y-4">
            {/* Colheita Selecionada */}
            <Card className="bg-white shadow-sm border-l-4 border-l-green-500">
              <CardContent className="p-4">
                <div className="flex items-start justify-between mb-2">
                  <div>
                    <h3 className="text-lg font-semibold text-green-700 flex items-center gap-2">
                      {selectedHarvest.group ? (
                        <>
                          <Users className="w-5 h-5" />
                          {selectedHarvest.group.name}
                        </>
                      ) : (
                        <>
                          <User className="w-5 h-5" />
                          {selectedHarvest.producer?.name || "Produtor"}
                        </>
                      )}
                    </h3>
                  </div>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => setSelectedHarvest(null)}
                  >
                    Trocar
                  </Button>
                </div>

                <div className="space-y-1 text-sm">
                  <p>
                    <span className="font-medium">Disponível:</span>{" "}
                    {selectedHarvest.quantity} sacas
                  </p>
                  <p>
                    <span className="font-medium">Data:</span>{" "}
                    {new Date(selectedHarvest.dateOfHarvest).toLocaleDateString("pt-BR")}
                  </p>
                </div>
              </CardContent>
            </Card>

            {/* Formulário */}
            <Card className="bg-white shadow-sm">
              <CardContent className="p-4 space-y-4">
                <div>
                  <Label htmlFor="quantity" className="text-[#62331B] font-semibold">
                    Quantidade de Sacas
                  </Label>
                  <Input
                    id="quantity"
                    type="number"
                    placeholder="Ex: 50"
                    value={quantity}
                    onChange={(e) => setQuantity(e.target.value)}
                    min="1"
                    max={selectedHarvest.quantity}
                    className="mt-1.5"
                    required
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Máximo: {selectedHarvest.quantity} sacas
                  </p>
                </div>

                <div>
                  <Label htmlFor="valuePerSack" className="text-[#62331B] font-semibold">
                    Valor por Saca (R$)
                  </Label>
                  <Input
                    id="valuePerSack"
                    type="number"
                    step="0.01"
                    placeholder="Ex: 385.50"
                    value={valuePerSack}
                    onChange={(e) => setValuePerSack(e.target.value)}
                    min="0.01"
                    className="mt-1.5"
                    required
                  />
                </div>

                {quantity && valuePerSack && (
                  <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                    <p className="text-sm text-gray-700 mb-1">
                      <span className="font-medium">Valor Total da Proposta:</span>
                    </p>
                    <p className="text-2xl font-bold text-green-700">
                      R${" "}
                      {(Number.parseFloat(valuePerSack) * Number.parseInt(quantity)).toFixed(2)}
                    </p>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Botões */}
            <div className="space-y-2">
              <Button
                type="submit"
                className="w-full bg-[#62331B] text-white hover:bg-[#4a2415] cursor-pointer"
                size="lg"
              >
                Enviar Proposta
              </Button>

              <Button
                type="button"
                variant="outline"
                className="w-full cursor-pointer"
                onClick={() => navigate({ to: "/proposals" })}
              >
                Cancelar
              </Button>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}
